(()=>{"use strict";function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t(e)}function e(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,i(r.key),r)}}function i(e){var i=function(e,i){if("object"!==t(e)||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,"string");if("object"!==t(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"===t(i)?i:String(i)}var n,r,l,s=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.reset()}var i,n;return i=t,(n=[{key:"level",get:function(){return Math.floor(.1*this.lines)}},{key:"getState",value:function(){for(var t=this._createPlayField(),e=this.activeFigure,i=e.y,n=e.x,r=e.blocks,l=0;l<this.playField.length;l++){t[l]=[];for(var s=0;s<this.playField[l].length;s++)t[l][s]=this.playField[l][s]}for(var o=0;o<r.length;o++)for(var h=0;h<r[o].length;h++)r[o][h]&&(t[i+o][n+h]=r[o][h]);return{score:this.score,level:this.level,lines:this.lines,nextFigure:this.nextFigure,playField:t,isGameOver:this._topOut}}},{key:"reset",value:function(){this.score=0,this.lines=0,this._topOut=!1,this.playField=this._createPlayField(),this.activeFigure=this._createFigure(),this.nextFigure=this._createFigure()}},{key:"_createPlayField",value:function(){for(var t=[],e=0;e<20;e++){t[e]=[];for(var i=0;i<10;i++)t[e][i]=0}return t}},{key:"_createFigure",value:function(){var t={};switch("IJLOSTZ"[Math.floor(7*Math.random())]){case"I":t.blocks=[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]];break;case"J":t.blocks=[[0,0,0],[1,1,1],[0,0,1]];break;case"L":t.blocks=[[0,0,0],[1,1,1],[1,0,0]];break;case"O":t.blocks=[[0,0,0,0],[0,1,1,0],[0,1,1,0],[0,0,0,0]];break;case"S":t.blocks=[[0,0,0],[0,1,1],[1,1,0]];break;case"T":t.blocks=[[0,0,0],[1,1,1],[0,1,0]];break;case"Z":t.blocks=[[0,0,0],[1,1,0],[0,1,1]];break;default:throw new Error("Неизвестная фигура")}return t.x=Math.floor((10-t.blocks[0].length)/2),t.y=-1,t}},{key:"rotateFigure",value:function(){for(var t=this.activeFigure.blocks,e=t.length,i=[],n=0;n<e;n++)i[n]=new Array(e).fill(0);for(var r=0;r<e;r++)for(var l=0;l<e;l++)i[l][r]=t[e-1-r][l];this.activeFigure.blocks=i,this._checkCollision()&&(this.activeFigure.blocks=t)}},{key:"moveFigureLeft",value:function(){this.activeFigure.x-=1,this._checkCollision()&&(this.activeFigure.x+=1)}},{key:"moveFigureRight",value:function(){this.activeFigure.x+=1,this._checkCollision()&&(this.activeFigure.x-=1)}},{key:"moveFigureDown",value:function(){if(!this._topOut){if(this.activeFigure.y+=1,this._checkCollision()){this.activeFigure.y-=1,this._lockFigure(),this._updateFigure();var t=this._clearLines();this._updateScore(t)}this._checkCollision()&&(this._topOut=!0)}}},{key:"_checkCollision",value:function(){for(var t=this.activeFigure,e=t.y,i=t.x,n=t.blocks,r=0;r<n.length;r++)for(var l=0;l<n[r].length;l++)if(n[r][l]&&(void 0===this.playField[e+r]||void 0===this.playField[e+r][i+l]||1===this.playField[e+r][i+l]))return!0;return!1}},{key:"_lockFigure",value:function(){for(var t=this.activeFigure,e=t.y,i=t.x,n=t.blocks,r=0;r<n.length;r++)for(var l=0;l<n[r].length;l++)n[r][l]&&(this.playField[e+r][i+l]=n[r][l])}},{key:"_updateFigure",value:function(){this.activeFigure=this.nextFigure,this.nextFigure=this._createFigure()}},{key:"_updateScore",value:function(e){e>0&&(this.score+=t.points[e]*(this.level+1),this.lines+=e)}},{key:"_clearLines",value:function(){for(var t=[],e=19;e>=0;e--){for(var i=0,n=0;n<10;n++)this.playField[e][n]&&(i+=1);if(0===i)break;i<10||t.unshift(e)}for(var r=0,l=t;r<l.length;r++){var s=l[r];this.playField.splice(s,1),this.playField.unshift(new Array(10).fill(0))}return t.length}}])&&e(i.prototype,n),Object.defineProperty(i,"prototype",{writable:!1}),t}();function o(t){return o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},o(t)}function h(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,a(n.key),n)}}function a(t){var e=function(t,e){if("object"!==o(t)||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!==o(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"===o(e)?e:String(e)}n=s,l={1:100,2:300,3:700,4:1500},(r=i(r="points"))in n?Object.defineProperty(n,r,{value:l,enumerable:!0,configurable:!0,writable:!0}):n[r]=l;var c=function(){function t(e,i,n,r,l){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this._element=e,this._width=i,this._height=n,this._canvas=document.createElement("canvas"),this._canvas.width=this._width,this._canvas.height=this._height,this._context=this._canvas.getContext("2d"),this._playFieldBorderWidth=4,this._playFieldX=this._playFieldBorderWidth,this._playFieldY=this._playFieldBorderWidth,this._playFieldWidth=2*this._width/3,this._playField_Height=this._height,this._playFieldInnerWidth=this._playFieldWidth-2*this._playFieldBorderWidth,this._playFieldInner_Height=this._playField_Height-2*this._playFieldBorderWidth,this._blockWidth=this._playFieldInnerWidth/l,this._block_Height=this._playFieldInner_Height/r,this._panelX=this._playFieldWidth+10,this._panelY=0,this._element.appendChild(this._canvas)}var e,i;return e=t,(i=[{key:"renderScreen",value:function(t){this._clearField(),this._renderPlayField(t),this._renderPanel(t)}},{key:"renderStartScreen",value:function(){this._context.fillStyle="white",this._context.font='24px "Segoe UI"',this._context.textAlign="center",this._context.textBaseline="middle",this._context.fillText("Press Enter to Start",this._width/2,this._height/2)}},{key:"renderPauseScreen",value:function(){this._context.fillStyle="rgba(0, 0, 0, 0.75)",this._context.fillRect(0,0,this._width,this._height),this._context.fillStyle="white",this._context.font='24px "Segoe UI"',this._context.textAlign="center",this._context.textBaseline="middle",this._context.fillText("Press Enter to Resume",this._width/2,this._height/2)}},{key:"renderGameOverScren",value:function(t){var e=t.score;this._context.fillStyle="rgba(0, 0, 0, 0.75)",this._context.fillRect(0,0,this._width,this._height),this._context.fillStyle="white",this._context.font='24px "Segoe UI"',this._context.textAlign="center",this._context.textBaseline="middle",this._context.fillText("GAME OVER",this._width/2,this._height/2-48),this._context.fillText("Score: ".concat(e),this._width/2,this._height/2),this._context.fillText("Press Enter to Restart",this._width/2,this._height/2+48)}},{key:"_clearField",value:function(){this._context.clearRect(0,0,this._width,this._height)}},{key:"_renderPlayField",value:function(t){for(var e=t.playField,i=0;i<e.length;i++)for(var n=e[i],r=0;r<n.length;r++)n[r]&&this._renderBlock(this._playFieldX+r*this._blockWidth,this._playFieldY+i*this._block_Height,this._blockWidth,this._block_Height,"red");this._context.strokeStyle="white",this._context.lineWidth=this._playFieldBorderWidth,this._context.strokeRect(0,0,this._playFieldWidth,this._playField_Height)}},{key:"_renderPanel",value:function(t){var e=t.level,i=t.score,n=t.lines,r=t.nextFigure;this._context.textAlign="start",this._context.textBaseline="top",this._context.fillStyle="white",this._context.font='14px "Segoe UI"',this._context.fillText("Level: ".concat(e),this._panelX,this._panelY+10),this._context.fillText("Score: ".concat(i),this._panelX,this._panelY+34),this._context.fillText("Lines: ".concat(n),this._panelX,this._panelY+58),this._context.fillText("Next:",this._panelX,this._panelY+106);for(var l=0;l<r.blocks.length;l++)for(var s=0;s<r.blocks[l].length;s++)r.blocks[l][s]&&this._renderBlock(this._panelX+s*this._blockWidth/2,this._panelY+105+l*this._block_Height/2,this._blockWidth/2,this._block_Height/2,"red")}},{key:"_renderBlock",value:function(t,e,i,n,r){this._context.fillStyle=r,this._context.strokeStyle="black",this._context.lineWidth=2,this._context.fillRect(t,e,i,n),this._context.strokeRect(t,e,i,n)}}])&&h(e.prototype,i),Object.defineProperty(e,"prototype",{writable:!1}),t}();function u(t){return u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},u(t)}function _(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,y(n.key),n)}}function y(t){var e=function(t,e){if("object"!==u(t)||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!==u(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"===u(e)?e:String(e)}var f=function(){function t(e,i){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this._game=e,this._view=i,this._interval=null,this._isPlaying=!1,document.addEventListener("keydown",this._handleKeyDown.bind(this)),document.addEventListener("keyup",this._handleKeyUp.bind(this)),this._view.renderStartScreen()}var e,i;return e=t,(i=[{key:"_update",value:function(){this._game.moveFigureDown(),this._updateView()}},{key:"_play",value:function(){this._isPlaying=!0,this._startTimer(),this._updateView()}},{key:"_pause",value:function(){this._isPlaying=!1,this._stopTimer(),this._updateView()}},{key:"_reset",value:function(){this._game.reset(),this._play()}},{key:"_updateView",value:function(){var t=this._game.getState();t.isGameOver?(this._stopTimer(),this._isPlaying=!1,this._view.renderGameOverScren(t)):this._isPlaying?this._view.renderScreen(t):this._view.renderPauseScreen()}},{key:"_startTimer",value:function(){var t=this,e=1e3-100*this._game.getState().level;this._interval||(this._interval=setInterval((function(){t._update()}),e>0?e:100))}},{key:"_stopTimer",value:function(){this._interval&&(clearInterval(this._interval),this._interval=null)}},{key:"_handleKeyDown",value:function(t){switch(t.keyCode){case 13:this._game.getState().isGameOver?this._reset():this._isPlaying?this._pause():this._play();break;case 37:if(!this._isPlaying)return;this._game.moveFigureLeft(),this._updateView();break;case 38:if(!this._isPlaying)return;this._game.rotateFigure(),this._updateView();break;case 39:if(!this._isPlaying)return;this._game.moveFigureRight(),this._updateView();break;case 40:if(!this._isPlaying)return;this._stopTimer(),this._game.moveFigureDown(),this._updateView()}}},{key:"_handleKeyUp",value:function(t){if(40===t.keyCode){if(!this._isPlaying)return;this._startTimer()}}}])&&_(e.prototype,i),Object.defineProperty(e,"prototype",{writable:!1}),t}(),v=document.querySelector(".content");new f(new s,new c(v,480,640,20,10))})();